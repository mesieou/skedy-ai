name: Deploy Skedy AI to Kamatera

on:
  push:
    branches: [ main ]  # Changed from master to main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: kamatera

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        printf '%s\n' "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/deploy_key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}

    - name: Deploy Skedy AI to Kamatera (Zero-Downtime)
      run: |
        IMAGE_TAG=$(date +%Y%m%d%H%M)
        echo "üîñ Using image tag: $IMAGE_TAG"

        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@45.151.154.42 << EOF
        set -e

        APP_DIR="/root/skedy-ai"
        CONTAINER_NAME="skedy-ai"
        IMAGE_NAME="skedy-ai"

        # Pull latest code first (before stopping anything)
        echo "üì• Pulling latest code..."
        if [ -d "/root/skedy-ai" ]; then
          cd /root/skedy-ai
          git pull origin main
        else
          git clone https://github.com/mesieou/skedy-ai.git /root/skedy-ai
          cd /root/skedy-ai
        fi

        # Build new Docker image with timestamp tag (don't overwrite existing)
        TIMESTAMP=\$(date +%Y%m%d%H%M%S)
        NEW_IMAGE="skedy-ai:\$TIMESTAMP"
        echo "üî® Building new Docker image: \$NEW_IMAGE"

        if ! docker build -t "\$NEW_IMAGE" .; then
          echo "‚ùå Docker build failed - keeping existing containers running"
          exit 1
        fi

        # Create .env file with secrets
        cat > .env << ENVEOF
        NODE_ENV=production
        NEXT_TELEMETRY_DISABLED=1
        NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY }}
        SUPABASE_SECRET_KEY=${{ secrets.SUPABASE_SECRET_KEY }}
        VOICE_REDIS_HOST=${{ secrets.VOICE_REDIS_HOST }}
        VOICE_REDIS_PORT=${{ secrets.VOICE_REDIS_PORT }}
        VOICE_REDIS_DB=${{ secrets.VOICE_REDIS_DB }}
        VOICE_REDIS_PASSWORD=${{ secrets.VOICE_REDIS_PASSWORD }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        OPENAI_WEBHOOK_SECRET=${{ secrets.OPENAI_WEBHOOK_SECRET }}
        TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
        TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
        TWILIO_PHONE_NUMBER=${{ secrets.TWILIO_PHONE_NUMBER }}
        GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
        DEMO_REMOVALIST_BUSINESS_ID=${{ secrets.DEMO_REMOVALIST_BUSINESS_ID }}
        DEMO_MANICURIST_BUSINESS_ID=${{ secrets.DEMO_MANICURIST_BUSINESS_ID }}
        DEMO_PLUMBER_BUSINESS_ID=${{ secrets.DEMO_PLUMBER_BUSINESS_ID }}
        CRON_SECRET=${{ secrets.CRON_SECRET }}
        SENTRY_DSN=${{ secrets.SENTRY_DSN }}
        SENTRY_API_KEY=${{ secrets.SENTRY_API_KEY }}
        ENVEOF

        # Create temporary docker-compose file with new image
        sed "s|skedy-ai:latest|\$NEW_IMAGE|g" docker-compose.cron.yml > docker-compose.new.yml

        # Start new containers on different ports for testing
        echo "üß™ Starting new containers for testing..."
        sed -i 's|"3000:3000"|"3001:3000"|g' docker-compose.new.yml

        if ! docker-compose -f docker-compose.new.yml up -d; then
          echo "‚ùå Failed to start new containers - keeping existing ones running"
          docker-compose -f docker-compose.new.yml down || true
          rm -f docker-compose.new.yml
          exit 1
        fi

        # Wait for new containers to be ready
        echo "‚è≥ Waiting for new containers to be ready..."
        sleep 10

        # Health check on new containers
        NEW_APP_CONTAINER=\$(docker-compose -f docker-compose.new.yml ps -q skedy-app)
        NEW_CRON_CONTAINER=\$(docker-compose -f docker-compose.new.yml ps -q availability-cron)

        if [ -z "\$NEW_APP_CONTAINER" ] || [ -z "\$NEW_CRON_CONTAINER" ]; then
          echo "‚ùå New containers not found - rolling back"
          docker-compose -f docker-compose.new.yml down || true
          rm -f docker-compose.new.yml
          exit 1
        fi

        # Test new app container health
        echo "üîç Testing new app container health..."
        if ! curl -f http://localhost:3001/api/health --max-time 30; then
          echo "‚ùå New app failed health check - rolling back"
          docker-compose -f docker-compose.new.yml down || true
          rm -f docker-compose.new.yml
          exit 1
        fi

        # Check if new containers are still running
        if ! docker ps | grep -q "\$NEW_APP_CONTAINER" || ! docker ps | grep -q "\$NEW_CRON_CONTAINER"; then
          echo "‚ùå New containers crashed - rolling back"
          docker-compose -f docker-compose.new.yml down || true
          rm -f docker-compose.new.yml
          exit 1
        fi

        echo "‚úÖ New containers are healthy - switching traffic"

        # Now stop old containers and start new ones on correct ports
        echo "‚èπÔ∏è Stopping old containers..."
        docker-compose -f docker-compose.cron.yml down || true
        docker stop skedy-ai || true  # fallback for old single container
        docker rm skedy-ai || true

        # Stop test containers
        docker-compose -f docker-compose.new.yml down

        # Tag new image as latest
        docker tag "\$NEW_IMAGE" "skedy-ai:latest"

        # Start new containers on production ports
        echo "üöÄ Starting new containers on production ports..."
        docker-compose -f docker-compose.cron.yml up -d

        # Final verification
        sleep 5
        if docker ps | grep -q skedy-app && docker ps | grep -q availability-cron; then
          echo "‚úÖ Deployment completed successfully!"
          echo "üì± Main app logs:"
          docker logs --tail 5 \$(docker-compose -f docker-compose.cron.yml ps -q skedy-app)
          echo "‚è∞ Cron service logs:"
          docker logs --tail 5 \$(docker-compose -f docker-compose.cron.yml ps -q availability-cron)

          # Clean up old images (keep last 2 versions)
          echo "üßπ Cleaning up old images..."
          docker images skedy-ai --format "table {{.Tag}}" | grep -E '^[0-9]{14}\$' | sort -r | tail -n +3 | xargs -r -I {} docker rmi "skedy-ai:{}" || true
        else
          echo "‚ùå Final verification failed"
          docker-compose -f docker-compose.cron.yml logs
          exit 1
        fi

        # Cleanup
        rm -f docker-compose.new.yml
        EOF
